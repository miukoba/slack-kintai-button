<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Slack å‹¤æ€  Button</title>
    <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
    <style>
        .post, #clear_histories {
            width: 162px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<input id="reply_broadcast" type="checkbox" />
<label for="reply_broadcast" style="display:inline-block">ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚‚æŠ•ç¨¿</label>

<h1>å›ºå®šæŠ•ç¨¿</h1>
<p>
    <button type="button" class="post" id="start_working">å‹¤å‹™é–‹å§‹ã—ã¾ã™</button>
</p>
<p>
    <button type="button" class="post" id="take_a_break">60åˆ†ä¼‘æ†©ã—ã¾ã™</button>
    &nbsp;
    <input type="radio" name="breakOption" value="60" onclick="switchBreakTime()" checked>60
    <input type="radio" name="breakOption" value="45" onclick="switchBreakTime()">45
    <input type="radio" name="breakOption" value="30" onclick="switchBreakTime()">30
    <input type="radio" name="breakOption" value="15" onclick="switchBreakTime()">15
</p>
<p>
    <button type="button" class="post" id="afk">æš«ãé›¢å¸­ã—ã¾ã™</button>
</p>
<p>
    <button type="button" class="post" id="break_is_over">æˆ»ã‚Šã¾ã—ãŸ</button>
</p>
<p>
    <button type="button" class="post" id="finish_working"  style="margin-right: 16px;">å‹¤å‹™çµ‚äº†ã—ã¾ã™</button>
    <a href="https://www2.kintaiatweb.jp/kwlmi/Login.aspx" target="_blank">å‹¤æ€ @Web</a>
</p>
<p>
    <button type="button" class="post" id="mistake">â†‘é–“é•ã„ã§ã™... :bow:</button>
</p>
<hr>
<h1>ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿</h1>
<p>
    <span id="custom-text-info" style="display:none">â†“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ config.js ã§è¨­å®šå¯èƒ½ã§ã™</span>
    <textarea name="custom_text" id="custom_text"  style="margin-bottom: 0px"></textarea>
    <button type="button" class="post" id="custom">â†‘ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æŠ•ç¨¿</button>
</p>

<hr>

<h1>å±¥æ­´</h1>
<button type="button" id="clear_histories">ã‚¯ãƒªã‚¢ã™ã‚‹</button>
<textarea id="histories" cols="30" rows="30" style="margin-top: 8px;"></textarea>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/locale/ja.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<script src="config.js"></script>
<script>
    // console.log(target_list)
    const HISTORIES_KEY = 'slack-kintai-histories'

    function showHistories() {
        const histories = loadHistories();
        $('#histories').val(histories.join("\n"));
    }

    function loadHistories() {
        let histories = JSON.parse(localStorage.getItem(HISTORIES_KEY));
        histories ||= [];
        return histories;
    }

    function saveHistories(message) {
        let histories = loadHistories();
        histories.push(message);
        localStorage.setItem(HISTORIES_KEY, JSON.stringify(histories));
    }

    function specifyBreakTime() {
        let breakOptions = document.getElementsByName('breakOption');
        let len = breakOptions.length;
        let breakTime = '';
        for(let i = 0; i < len; i++) {
            if(breakOptions.item(i).checked) {
                breakTime = breakOptions.item(i).value;
                break;
            }
        }
        return breakTime;
    }

    function switchBreakTime() {
        let item = document.getElementById('take_a_break');
        item.innerText = specifyBreakTime() + 'åˆ†ä¼‘æ†©ã—ã¾ã™';
    }

    var options = {
        label: 'ğŸŒ“'
    }
    new Darkmode(options).showWidget();

    $(function () {
        showHistories()

        $('#clear_histories').on('click', function (event) {
            localStorage.removeItem(HISTORIES_KEY);
            showHistories();
        });

        if (typeof default_custom_message === 'undefined') {
            $('#custom-text-info').show()
            default_custom_message = 'ã¾ã§é›¢å¸­ã—ã¾ã™'
        }
        // console.log(default_custom_message)
        $('#custom_text').val(default_custom_message)

        // ä¸€æ—¦ â—¯â—¯ã¾ã§é›¢å¸­ã—ã¾ã™ ã‚’æƒ³å®šã—ã¦ã€ã‚«ãƒ¼ã‚½ãƒ«ã¯æœ€åˆã«ç§»å‹•
        $('#custom_text').trigger('focus').get(0).setSelectionRange(0, 0)

        $('.post').on('click', function (event) {
            let reply_broadcast = $('#reply_broadcast').prop('checked')

            dayjs.locale('ja')
            let now = dayjs()
            let now_date = now.format('YYYY/MM/DD(ddd)')
            let now_time = now.format('HH:mm')
            let now_add_1_hour_time = now.add(1, 'hour').format('HH:mm')
            let now_add_45_minute_time = now.add(45, 'minute').format('HH:mm')
            let now_add_30_minute_time = now.add(30, 'minute').format('HH:mm')
            let now_add_15_minute_time = now.add(15, 'minute').format('HH:mm')
            let now_full = now_date + ' ' + now_time

            let message_start_working = 'å‹¤å‹™é–‹å§‹ã—ã¾ã™ ' + now_full

            // let message_take_a_break = '1æ™‚é–“ä¼‘æ†©ã—ã¾ã™ ' + now_time + '-' + now_add_1_hour_time + 'äºˆå®šã§ã™'
            let message_take_a_break_60 = '60åˆ†ä¼‘æ†©ã—ã¾ã™ ' + now_time + '-' + now_add_1_hour_time + 'äºˆå®šã§ã™'
            let message_take_a_break_45 = '45åˆ†ä¼‘æ†©ã—ã¾ã™ ' + now_time + '-' + now_add_45_minute_time + 'äºˆå®šã§ã™'
            let message_take_a_break_30 = '30åˆ†ä¼‘æ†©ã—ã¾ã™ ' + now_time + '-' + now_add_30_minute_time + 'äºˆå®šã§ã™'
            let message_take_a_break_15 = '15åˆ†ä¼‘æ†©ã—ã¾ã™ ' + now_time + '-' + now_add_15_minute_time + 'äºˆå®šã§ã™'

            let message_afk = 'æš«ãé›¢å¸­ã—ã¾ã™ ' + now_time
            let message_break_is_over = 'æˆ»ã‚Šã¾ã—ãŸ ' + now_time
            let message_finish_working = 'å‹¤å‹™çµ‚äº†ã—ã¾ã™ ' + now_full
            let message_mistake = 'â†‘é–“é•ã„ã§ã™... :bow:'
            let message_custom = $('#custom_text').val()

            let url = 'https://slack.com/api/chat.postMessage'
            let ele_id = $(this).attr('id')

            let message;

            if (ele_id == 'take_a_break') {
                message = eval('message_' + ele_id + '_' + specifyBreakTime());
            } else {
                message = eval('message_' + ele_id)
            }

            const isAgreed = window.confirm('æŠ•ç¨¿ã—ã¾ã™ã‹ï¼Ÿã€Œ' + message + 'ã€')
            if (!isAgreed) {
                console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ')
                return
            }

            saveHistories(now_full + "\t" + message);
            showHistories();

            target_list.forEach((t) => {
                let param_channel = t[0]
                let param_thread_ts = t[1]
                let param_token = t[2]
                let data = {
                    token: param_token,
                    channel: param_channel,
                    username: user_name,
                    icon_url: icon_url,
                    text: message,
                    reply_broadcast: reply_broadcast,
                    thread_ts: param_thread_ts,
                }

                // console.log(data)
                $.ajax({
                    type: 'GET',
                    url: url,
                    data: data,
                }).then(
                    data => console.log('success'),
                    error => alert('error!')
                )
            })
        })
    })
</script>
</body>
</html>
